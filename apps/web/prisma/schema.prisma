generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NextAuth.js required models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              Agent   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         Agent    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Application models
model Agent {
  id             String           @id @default(cuid())
  email          String           @unique
  emailVerified  DateTime?
  name           String
  image          String?
  phone          String?
  brokerage      String?
  licenseNumber  String?
  timezone       String           @default("America/Los_Angeles")
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  accounts       Account[]
  sessions       Session[]
  listings       Listing[]
  socialAccounts SocialAccount[]
  posts          Post[]
  leads          Lead[]
  settings       AgentSettings?
}

model AgentSettings {
  id                String  @id @default(cuid())
  agentId           String  @unique
  agent             Agent   @relation(fields: [agentId], references: [id], onDelete: Cascade)
  defaultTone       String  @default("family")
  defaultLanguage   String  @default("en")
  autoReplyEnabled  Boolean @default(true)
  workingHoursStart String  @default("09:00")
  workingHoursEnd   String  @default("18:00")
  workingDays       Int[]   @default([1, 2, 3, 4, 5])
  bufferMinutes     Int     @default(30)
  mlsProvider       String?
  mlsApiKey         String?
}

model SocialAccount {
  id            String   @id @default(cuid())
  agentId       String
  agent         Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  platform      Platform
  accountId     String
  accountName   String
  accessToken   String   @db.Text
  refreshToken  String?  @db.Text
  tokenExpiry   DateTime?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([agentId, platform, accountId])
}

model Listing {
  id          String             @id @default(cuid())
  mlsId       String?            @unique
  agentId     String
  agent       Agent              @relation(fields: [agentId], references: [id], onDelete: Cascade)
  address     String
  city        String
  state       String
  zipCode     String
  price       Decimal
  beds        Int
  baths       Float
  sqft        Int
  description String?            @db.Text
  features    String[]
  photos      String[]
  status      ListingStatus      @default(ACTIVE)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  content     GeneratedContent[]
  posts       Post[]
}

model GeneratedContent {
  id        String      @id @default(cuid())
  listingId String
  listing   Listing     @relation(fields: [listingId], references: [id], onDelete: Cascade)
  type      ContentType
  platform  Platform?
  tone      String
  language  String      @default("en")
  body      String      @db.Text
  hashtags  String[]
  variant   Int         @default(1)
  selected  Boolean     @default(false)
  createdAt DateTime    @default(now())
}

model Post {
  id             String     @id @default(cuid())
  listingId      String?
  listing        Listing?   @relation(fields: [listingId], references: [id])
  agentId        String
  agent          Agent      @relation(fields: [agentId], references: [id], onDelete: Cascade)
  platform       Platform
  content        String     @db.Text
  mediaUrls      String[]
  scheduledAt    DateTime?
  publishedAt    DateTime?
  platformPostId String?
  status         PostStatus @default(DRAFT)
  engagement     Json?
  replies        Reply[]
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
}

model Reply {
  id           String      @id @default(cuid())
  postId       String
  post         Post        @relation(fields: [postId], references: [id], onDelete: Cascade)
  platform     Platform
  authorName   String
  authorId     String
  body         String      @db.Text
  intent       ReplyIntent
  responded    Boolean     @default(false)
  responseBody String?     @db.Text
  leadId       String?
  lead         Lead?       @relation(fields: [leadId], references: [id])
  createdAt    DateTime    @default(now())
}

model Lead {
  id           String        @id @default(cuid())
  agentId      String
  agent        Agent         @relation(fields: [agentId], references: [id], onDelete: Cascade)
  name         String
  email        String?
  phone        String?
  source       Platform
  score        Int           @default(0)
  status       LeadStatus    @default(NEW)
  replies      Reply[]
  appointments Appointment[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Appointment {
  id              String            @id @default(cuid())
  leadId          String
  lead            Lead              @relation(fields: [leadId], references: [id], onDelete: Cascade)
  listingId       String?
  type            String
  startTime       DateTime
  endTime         DateTime
  location        String?
  calendarEventId String?
  calendlyEventId String?
  status          AppointmentStatus @default(PENDING)
  notes           String?           @db.Text
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
}

enum Platform {
  FACEBOOK
  INSTAGRAM
  TIKTOK
  LINKEDIN
  X
  YOUTUBE
}

enum ListingStatus {
  ACTIVE
  PENDING
  SOLD
  WITHDRAWN
  EXPIRED
}

enum ContentType {
  SOCIAL_POST
  LISTING_DESC
  EMAIL
  VIDEO_SCRIPT
  OPEN_HOUSE_FLYER
}

enum PostStatus {
  DRAFT
  SCHEDULED
  PUBLISHING
  PUBLISHED
  FAILED
}

enum ReplyIntent {
  INQUIRY
  SHOWING_REQUEST
  PRICE_QUESTION
  SPAM
  NEGOTIATION
  COMPLIMENT
  UNKNOWN
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  SHOWING_SCHEDULED
  CLOSED
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}
